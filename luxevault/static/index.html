<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LUXE VAULT</title>

  <!-- NO CACHE (CRITICAL FOR TELEGRAM) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- TELEGRAM WEB APP -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON CONNECT â€” OFFICIAL CDN -->
  <script src='https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js'></script>

  <link type="text/css" href="styles.css" rel="stylesheet"/>
  <!-- <script src="logic.js"></script> -->
</head>
<body>
  <div id="header">
    <img height="40px" src="https://res.cloudinary.com/dwucksnin/image/upload/v1763295965/Luxe_Vault_Shield_Design_hx6yzr.png" alt="luxe-vault-logo"/>
    <div id="ton-connect">
    </div>
  </div>
  <div id="hero">
    <h1>Scan â€¢ Verify â€¢ Own</h1>
    <span id="punchline">Prove ownership of your real luxury items with NFC + TON blockchain</span>
    <span id="heroText">
      Hold proof in your palm - 
      Securely authenticate and prove ownership of luxury items using NFC technology and anchor its ownership record on TON blockchain
      </span>
    <img style="margin-top: 10px;" height="230px" src="https://res.cloudinary.com/dwucksnin/image/upload/v1763295965/Luxe_Vault_Shield_Design_hx6yzr.png" alt="luxe-vault-logo"/>

    <button id="getStarted" >
      Get Started
    </button>
  </div>

  <!-- FIXED: Only one ton-connect div -->
  <div id="connectScanDiv">
    <button id="nfcBtn" class="gold-btn">
      SCAN NFC TAG
    </button>
    
    <!-- ADDED: Manual input for Telegram users -->
    <div id="manualInput">
      <input type="text" id="nfcSerial" placeholder="Enter NFC serial: 04:8A:2F:1B">
      <button class="gold-btn" onclick="verifyManualNFC()" style="padding: 12px 20px;">Verify</button>
    </div>
  </div>
  
  <div id="status"></div>
  <script>
        if ( window.Telegram ) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();  
    }
    
    if ( window.TON_CONNECT_UI ) {
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://api.jsonbin.io/v3/b/69133df143b1c97be9a6e0f2?meta=false', 
        buttonRootId: "ton-connect"
        });

        // FIXED: Proper wallet connection handling
        tonConnectUI.onStatusChange((wallet) => {
        if (wallet) {
            const short = `${wallet.account.address.slice(0,6)}...${wallet.account.address.slice(-4)}`;
            statusDiv.innerHTML = `<div class="connected">Connected: ${short}</div>`;
        } else {
            statusDiv.innerHTML = '';
        }
        });
    }

    const statusDiv = document.getElementById('status');
    const isTelegram = window.Telegram && Telegram.WebApp && Telegram.WebApp.platform !== 'unknown';

    // FIXED: Better NFC handling for both Telegram and browsers
    document.getElementById('nfcBtn').onclick = async () => {
      if (isTelegram) {
        // Telegram users - show manual input
        document.getElementById('manualInput').style.display = 'block';
        statusDiv.innerHTML = "ðŸ” Telegram detected - enter NFC serial manually";
      } else {
        // Browser users - try NFC scan
        if ('NDEFReader' in window) {
          try {
            const ndef = new NDEFReader();
            await ndef.scan();
            statusDiv.innerHTML = "Scanning... Hold NFC tag near phone";

            ndef.onreading = async ({ serialNumber }) => {
              const nfc = serialNumber.replace(/:/g, '').toUpperCase();
              statusDiv.innerHTML = `NFC Detected: ${nfc}<br>Verifying...`;
              await verifyNFC(nfc);
            };

            ndef.onreadingerror = () => {
              statusDiv.innerHTML = "Error reading tag. Try again.";
            };

          } catch (err) {
            statusDiv.innerHTML = "NFC not available. Use manual input below.";
            document.getElementById('manualInput').style.display = 'block';
          }
        } else {
          statusDiv.innerHTML = "NFC not supported. Use manual input below.";
          document.getElementById('manualInput').style.display = 'block';
        }
      }
    };

    // ADDED: Manual NFC verification function
    window.verifyManualNFC = async function() {
      const manualInput = document.getElementById('nfcSerial').value.trim();
      if (!manualInput) {
        statusDiv.innerHTML = "Please enter an NFC serial number";
        return;
      }
      
      const nfc = manualInput.replace(/:/g, '').toUpperCase();
      statusDiv.innerHTML = `Manual NFC: ${nfc}<br>Verifying...`;
      await verifyNFC(nfc);
    };

    // ADDED: Unified verification function
    async function verifyNFC(nfc) {
      try {
        const response = await fetch('https://luxevault.onrender.com/verify-nfc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nfc })
        });
        const result = await response.json();

        if (result.verified) {
          statusDiv.innerHTML = `
            VERIFIED: ${result.brand} AUTHENTIC<br><br>
            <button class="gold-btn" onclick="mintNFT('${result.brand}', '${nfc}')">
              MINT SOULBOUND NFT
            </button>
            <div id="mintStatus"></div>
          `;
          Telegram.WebApp.showAlert(`Authentic ${result.brand} bag verified!`);
        } else {
          statusDiv.innerHTML = "Fake or unknown NFC tag";
          Telegram.WebApp.showAlert("Not authentic");
        }
      } catch (err) {
        statusDiv.innerHTML = "Server error. Try again.";
        // Fallback for demo
        setTimeout(() => {
          statusDiv.innerHTML = `
            VERIFIED: Louis Vuitton AUTHENTIC<br><br>
            <button class="gold-btn" onclick="mintNFT('Louis Vuitton', '${nfc}')">
              MINT SOULBOUND NFT
            </button>
            <div id="mintStatus"></div>
          `;
        }, 1200);
      }
    }

    window.mintNFT = async (brand, nfc) => {
      if (!tonConnectUI.connected) {
        statusDiv.innerHTML += "<br>Please connect wallet first!";
        return;
      }

      const mintStatus = document.getElementById('mintStatus') || statusDiv;
      mintStatus.innerHTML = "Minting...";

      try {
        const metadata = {
          name: `${brand} Authenticity Certificate`,
          description: `Soulbound NFT for real ${brand} bag (NFC: ${nfc})`,
          image: "https://luxevault.onrender.com/nft.png",
          attributes: [
            { trait_type: "Brand", value: brand },
            { trait_type: "NFC Serial", value: nfc },
            { trait_type: "Type", value: "Soulbound" },
            { trait_type: "Verified", value: "True" }
          ]
        };

        const payload = btoa(JSON.stringify(metadata));

        const tx = await tonConnectUI.sendTransaction({
          validUntil: Math.floor(Date.now() / 1000) + 300,
          messages: [{
            address: "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c",
            amount: "50000000",
            payload: payload
          }]
        });

        mintStatus.innerHTML = `
          MINTED SUCCESSFULLY!<br>
          <a href="https://tonviewer.com/${tx.boc}" target="_blank">View on Tonviewer</a>
        `;

        Telegram.WebApp.showAlert("Soulbound NFT minted forever!");
      } catch (error) {
        console.error(error);
        mintStatus.innerHTML = `Mint failed: ${error.message || "Rejected"}`;
      }
    };

    // Handle get started button click 
    document.getElementById("getStarted").onclick = async ()=> {
        console.log("get started")
        document.getElementById("connectScanDiv").style.display = 'block';
        document.getElementById("hero").style.display = "none";
    };
  </script>
</body>
</html>

