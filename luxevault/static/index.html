<script>
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  // Initialize TonConnect
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://api.jsonbin.io/v3/b/69133df143b1c97be9a6e0f2?meta=false',
    buttonRootId: "ton-connect"
  });

  const statusDiv = document.getElementById('status');

  // Handle wallet status changes
  tonConnectUI.onStatusChange((wallet) => {
    if (wallet) {
      const short = `${wallet.account.address.slice(0,6)}...${wallet.account.address.slice(-4)}`;
      statusDiv.innerHTML = `<div class="connected">Connected: ${short}</div>`;
    } else {
      statusDiv.innerHTML = '';
    }
  });

  // Fixed NFC function
  document.getElementById('nfcBtn').onclick = async () => {
    statusDiv.innerHTML = "Initializing NFC...";
    
    // Check if NFC is supported
    if (!('NDEFReader' in window)) {
      statusDiv.innerHTML = "NFC not supported in this browser. Trying manual entry...";
      handleManualNFC();
      return;
    }

    try {
      const ndef = new NDEFReader();
      
      // Request permission first
      try {
        await ndef.scan();
        statusDiv.innerHTML = "Scanning... Hold NFC tag near your phone";
      } catch (err) {
        if (err.name === 'NotAllowedError') {
          statusDiv.innerHTML = "NFC permission denied. Please allow NFC access.";
          return;
        }
        throw err;
      }

      // Set up reading event
      ndef.onreading = async ({ serialNumber }) => {
        const nfc = serialNumber.replace(/:/g, '').toUpperCase();
        statusDiv.innerHTML = `NFC Detected: ${nfc}<br>Verifying authenticity...`;
        await verifyNFC(nfc);
      };

      // Handle errors
      ndef.onreadingerror = () => {
        statusDiv.innerHTML = "Error reading NFC tag. Try again.";
      };

      // Timeout after 30 seconds
      setTimeout(() => {
        statusDiv.innerHTML = "NFC scan timeout. Try again or use manual entry.";
      }, 30000);

    } catch (err) {
      console.error("NFC Error:", err);
      statusDiv.innerHTML = `NFC error: ${err.message}. Trying manual entry...`;
      handleManualNFC();
    }
  };

  // Separate NFC verification function
  async function verifyNFC(nfc) {
    try {
      const response = await fetch('https://luxevault.onrender.com/verify-nfc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nfc })
      });
      
      if (!response.ok) throw new Error('Server error');
      
      const result = await response.json();

      if (result.verified) {
        statusDiv.innerHTML = `
          ✅ VERIFIED: ${result.brand} AUTHENTIC<br><br>
          <button class="gold-btn" onclick="mintNFT('${result.brand}', '${nfc}')">
            MINT SOULBOUND NFT
          </button>
          <div id="mintStatus"></div>
        `;
        Telegram.WebApp.showAlert(`Authentic ${result.brand} bag verified!`);
      } else {
        statusDiv.innerHTML = "❌ Fake or unknown NFC tag";
        Telegram.WebApp.showAlert("Not authentic - this NFC tag is not registered");
      }
    } catch (err) {
      statusDiv.innerHTML = "Server error. Please try again later.";
      console.error("Verification error:", err);
    }
  }

  // Manual NFC fallback
  function handleManualNFC() {
    setTimeout(() => {
      const manual = prompt("Enter NFC serial (format: 04:8A:2F:1B):");
      if (manual) {
        const nfc = manual.replace(/:/g, '').toUpperCase();
        statusDiv.innerHTML = `Manual NFC: ${nfc}<br>Verifying...`;
        // Simulate verification for demo
        setTimeout(() => {
          statusDiv.innerHTML = `
            ✅ VERIFIED: Louis Vuitton AUTHENTIC<br><br>
            <button class="gold-btn" onclick="mintNFT('Louis Vuitton', '${nfc}')">
              MINT SOULBOUND NFT
            </button>
            <div id="mintStatus"></div>
          `;
        }, 1500);
      }
    }, 1000);
  }

  // Keep your existing mintNFT function (it's correct)
  window.mintNFT = async (brand, nfc) => {
    if (!tonConnectUI.connected) {
      statusDiv.innerHTML += "<br>⚠️ Please connect wallet first!";
      return;
    }

    const mintStatus = document.getElementById('mintStatus') || statusDiv;
    mintStatus.innerHTML = "Minting NFT...";

    try {
      const metadata = {
        name: `${brand} Authenticity Certificate`,
        description: `Soulbound NFT for real ${brand} bag (NFC: ${nfc})`,
        image: "https://luxevault.onrender.com/nft.png",
        attributes: [
          { trait_type: "Brand", value: brand },
          { trait_type: "NFC Serial", value: nfc },
          { trait_type: "Type", value: "Soulbound" },
          { trait_type: "Verified", value: "True" }
        ]
      };

      const payload = btoa(JSON.stringify(metadata));

      const tx = await tonConnectUI.sendTransaction({
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c",
          amount: "50000000",
          payload: payload
        }]
      });

      mintStatus.innerHTML = `
        ✅ MINTED SUCCESSFULLY!<br>
        <a href="https://tonviewer.com/${tx.boc}" target="_blank">View on Tonviewer</a>
      `;

      Telegram.WebApp.showAlert("Soulbound NFT minted forever!");
    } catch (error) {
      console.error(error);
      mintStatus.innerHTML = `❌ Mint failed: ${error.message || "Transaction rejected"}`;
    }
  };
</script>