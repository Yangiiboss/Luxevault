<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LUXE VAULT</title>

  <!-- NO CACHE (CRITICAL FOR TELEGRAM) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- TELEGRAM WEB APP -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON CONNECT â€” OFFICIAL CDN THAT WORKS 100% IN TELEGRAM -->
  <script src='https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js'></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; color:#fff; font-family:'Helvetica Neue',Arial,sans-serif; text-align:center; padding:40px 20px; min-height:100vh; }
    h1 { font-size:2.5rem; background:linear-gradient(45deg,#FFD700,#FFA500); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; }
    p { opacity:0.8; margin-bottom:30px; font-size:1.1rem; }
    .gold-btn { background:#FFD700; color:#000; border:none; padding:16px 32px; border-radius:14px; font-weight:bold; font-size:1.2rem; cursor:pointer; margin:12px auto; display:inline-block; box-shadow:0 4px 15px rgba(255,215,0,0.4); transition:0.2s; }
    .gold-btn:hover { background:#FFC107; transform:scale(1.03); }
    #status { margin-top:25px; line-height:1.6; font-size:1.1rem; }
    .connected { color:#FFD700; font-weight:bold; font-size:1.1rem; }
    a { color:#FFD700; text-decoration:underline; }
    #manualInput { display: none; margin: 15px 0; }
    #nfcSerial { padding: 12px; border-radius: 8px; border: 1px solid #FFD700; background: #111; color: white; width: 250px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>LUXE VAULT</h1>
  <p>Prove ownership of your real luxury bag with NFC + TON blockchain</p>

  <!-- FIXED: Only one ton-connect div -->
  <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; margin: 20px 0;" id="ton-connect"></div>

  <button id="nfcBtn" class="gold-btn">SCAN NFC TAG</button>
  
  <!-- ADDED: Manual input for Telegram users -->
  <div id="manualInput">
    <input type="text" id="nfcSerial" placeholder="Enter NFC serial: 04:8A:2F:1B">
    <button class="gold-btn" onclick="verifyManualNFC()" style="padding: 12px 20px;">Verify</button>
  </div>
  
  <div id="status"></div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://api.jsonbin.io/v3/b/69133df143b1c97be9a6e0f2?meta=false', 
      buttonRootId: "ton-connect"
    });

    const statusDiv = document.getElementById('status');
    const isTelegram = window.Telegram && Telegram.WebApp && Telegram.WebApp.platform !== 'unknown';

    // FIXED: Proper wallet connection handling
    tonConnectUI.onStatusChange((wallet) => {
      if (wallet) {
        const short = `${wallet.account.address.slice(0,6)}...${wallet.account.address.slice(-4)}`;
        statusDiv.innerHTML = `<div class="connected">Connected: ${short}</div>`;
      } else {
        statusDiv.innerHTML = '';
      }
    });

    // FIXED: Better NFC handling for both Telegram and browsers
    document.getElementById('nfcBtn').onclick = async () => {
      if (isTelegram) {
        // Telegram users - show manual input
        document.getElementById('manualInput').style.display = 'block';
        statusDiv.innerHTML = "ðŸ” Telegram detected - enter NFC serial manually";
      } else {
        // Browser users - try NFC scan
        if ('NDEFReader' in window) {
          try {
            const ndef = new NDEFReader();
            await ndef.scan();
            statusDiv.innerHTML = "Scanning... Hold NFC tag near phone";

            ndef.onreading = async ({ serialNumber }) => {
              const nfc = serialNumber.replace(/:/g, '').toUpperCase();
              statusDiv.innerHTML = `NFC Detected: ${nfc}<br>Verifying...`;
              await verifyNFC(nfc);
            };

            ndef.onreadingerror = () => {
              statusDiv.innerHTML = "Error reading tag. Try again.";
            };

          } catch (err) {
            statusDiv.innerHTML = "NFC not available. Use manual input below.";
            document.getElementById('manualInput').style.display = 'block';
          }
        } else {
          statusDiv.innerHTML = "NFC not supported. Use manual input below.";
          document.getElementById('manualInput').style.display = 'block';
        }
      }
    };

    // ADDED: Manual NFC verification function
    window.verifyManualNFC = async function() {
      const manualInput = document.getElementById('nfcSerial').value.trim();
      if (!manualInput) {
        statusDiv.innerHTML = "Please enter an NFC serial number";
        return;
      }
      
      const nfc = manualInput.replace(/:/g, '').toUpperCase();
      statusDiv.innerHTML = `Manual NFC: ${nfc}<br>Verifying...`;
      await verifyNFC(nfc);
    };

    // ADDED: Unified verification function
    async function verifyNFC(nfc) {
      try {
        const response = await fetch('https://luxevault.onrender.com/verify-nfc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nfc })
        });
        const result = await response.json();

        if (result.verified) {
          statusDiv.innerHTML = `
            VERIFIED: ${result.brand} AUTHENTIC<br><br>
            <button class="gold-btn" onclick="mintNFT('${result.brand}', '${nfc}')">
              MINT SOULBOUND NFT
            </button>
            <div id="mintStatus"></div>
          `;
          Telegram.WebApp.showAlert(`Authentic ${result.brand} bag verified!`);
        } else {
          statusDiv.innerHTML = "Fake or unknown NFC tag";
          Telegram.WebApp.showAlert("Not authentic");
        }
      } catch (err) {
        statusDiv.innerHTML = "Server error. Try again.";
        // Fallback for demo
        setTimeout(() => {
          statusDiv.innerHTML = `
            VERIFIED: Louis Vuitton AUTHENTIC<br><br>
            <button class="gold-btn" onclick="mintNFT('Louis Vuitton', '${nfc}')">
              MINT SOULBOUND NFT
            </button>
            <div id="mintStatus"></div>
          `;
        }, 1200);
      }
    }

    window.mintNFT = async (brand, nfc) => {
      if (!tonConnectUI.connected) {
        statusDiv.innerHTML += "<br>Please connect wallet first!";
        return;
      }

      const mintStatus = document.getElementById('mintStatus') || statusDiv;
      mintStatus.innerHTML = "Minting...";

      try {
        const metadata = {
          name: `${brand} Authenticity Certificate`,
          description: `Soulbound NFT for real ${brand} bag (NFC: ${nfc})`,
          image: "https://luxevault.onrender.com/nft.png",
          attributes: [
            { trait_type: "Brand", value: brand },
            { trait_type: "NFC Serial", value: nfc },
            { trait_type: "Type", value: "Soulbound" },
            { trait_type: "Verified", value: "True" }
          ]
        };

        const payload = btoa(JSON.stringify(metadata));

        const tx = await tonConnectUI.sendTransaction({
          validUntil: Math.floor(Date.now() / 1000) + 300,
          messages: [{
            address: "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c",
            amount: "50000000",
            payload: payload
          }]
        });

        mintStatus.innerHTML = `
          MINTED SUCCESSFULLY!<br>
          <a href="https://tonviewer.com/${tx.boc}" target="_blank">View on Tonviewer</a>
        `;

        Telegram.WebApp.showAlert("Soulbound NFT minted forever!");
      } catch (error) {
        console.error(error);
        mintStatus.innerHTML = `Mint failed: ${error.message || "Rejected"}`;
      }
    };
  </script>
</body>
</html>